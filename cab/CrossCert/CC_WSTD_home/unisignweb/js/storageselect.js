var __storageselect=function(a){var w=function(d){function v(b){if(!b)return alert("UI load error."),!1;if("CERT_STORAGE"===d.type||"CERT_STORAGE_ISSUE"===d.type)a.ESVS.TargetObj.innerHTML=b;else{var c=document.createElement("div");document.body.insertBefore(c,document.body.firstChild);c.innerHTML=b}return!0}function q(b,c,k){if(a.CONST.__USFB_M_DISK.device>b||!c||!k)return!1;var f=a.loadUI("driveselect")({type:"DEVICE_REMOVABLE_DISK",args:c,onConfirm:function(a){g=b;n=a;f.dispose();k.focus()},onCancel:function(){f.dispose();k.focus()}});f.show()}function l(b,c,k,f){var h=a.loadUI("sectokenselect")({type:b,args:c,onConfirm:function(c,e){g=b;n=c;"CERT_STORAGE_ISSUE"==d.type&&-1!=e.indexOf("BIO")?a.uiUtil().msgBox(f.IDS_MSGBOX_BLOCK_BIOTOKEN_FORISSUE):(h.dispose(),k.focus())},onCancel:function(){h.dispose();k.focus()}});h.show()}function s(b,c,k){if(a.CONST.__USFB_M_DISK.device>b||!driveList||!k)return!1;var f=a.loadUI("driveselect")({type:"DEVICE_SAVE_TOKEN",args:c,onConfirm:function(a){g=b;n=a;f.dispose();k.focus()},onCancel:function(){f.dispose();k.focus()}});f.show()}function y(b,c){var k=null;n=g=0;if(1===a.ESVS.Mode)if(a.plugin().valid){var f=a.plugin().GetDiskListNumNotDeviceSelect();if(0<f){for(var h=[],d=0;d<f;d++){var e=d+1,l={};l.index=e;l.name=a.plugin().GetDiskDriveName(e);h[d]=l}k={list:h}}else a.plugin().GetLastErrorCode()}else return a.uiUtil().msgBox(c.IDS_MSGBOX_PLUGIN_ERROR_UNLOAD),!1;else if(4&a.ESVS.Mode)if(a.nimservice())a.nimservice().GetDiskListNumNotDeviceSelect(a.CONST.__USFB_M_DISK.device,function(c){if(0<c){for(var f=[],e=0;e<c;e++){var d=e+1,h={};h.index=d;h.name=a.nimservice().GetDiskDriveName(d);f[e]=h}k={list:f}}else a.nimservice().GetLastErrorCode();q(a.CONST.__USFB_M_DISK.device,k,b)});else return a.uiUtil().msgBox(__text.IDS_MSGBOX_NIM_ERROR_UNLOAD),!1;4&a.ESVS.Mode||q(a.CONST.__USFB_M_DISK.device,k,b);return!0}function z(b,c){var k=null;n=g=0;if(1&a.ESVS.Mode)if(a.plugin().valid){var f=[],d=a.plugin().GetHSMInstallListNum();if(0<d)for(var p=0;p<d;p++){var e=p+1,m={},q=a.plugin().GetHSMInstallDriverName(e).split("|");m.index=e;m.name=q[0];m.driver=q[1];m.passage=q[2];m.validity=q[3];f[p]=m}k={list:f}}else return a.uiUtil().msgBox(c.IDS_MSGBOX_PLUGIN_ERROR_UNLOAD),!1;else if(4&a.ESVS.Mode)if(a.nimservice())a.nimservice().GetDiskListNumNotDeviceSelect(a.CONST.__USFB_M_HSMKEY.device,function(f){if(0<f){for(var e=[],d=0;d<f;d++){var h=d+1,g={},p=a.nimservice().GetSecureTokenName(h).split("|");g.index=h;g.name=p[0];g.driver=p[1];g.passage=p[2];e[d]=g}k={list:e}}else a.nimservice().GetLastErrorCode();l(a.CONST.__USFB_M_HSMKEY.device,k,b,c)});else return a.uiUtil().msgBox(__text.IDS_MSGBOX_NIM_ERROR_UNLOAD),!1;4&a.ESVS.Mode||l(a.CONST.__USFB_M_HSMKEY.device,k,b,c);return!0}function w(b,c){n=g=0;if(4&a.ESVS.Mode)if(a.nimservice())a.nimservice().GetDiskListNumNotDeviceSelect(a.CONST.__USFB_M_SMARTCARD.device,function(c){if(0<c){for(var f=[],d=0;d<c;d++){var g=d+1,e={};e.index=g;e.name=a.nimservice().GetSmartCardName(g);f[d]=e}driveList={list:f}}else return-1===c&&(c=a.nimservice().GetLastErrorCode(),f=a.nimservice().GetLastErrorMessage(),console.log("***** GetCertsFromRemovable *****"),console.log("Err Code : ",c,"\nErr Msg : ",f)),!1;s(a.CONST.__USFB_M_SMARTCARD.device,driveList,b)});else return a.uiUtil().msgBox(__text.IDS_MSGBOX_NIM_ERROR_UNLOAD),!1}function u(b,c){if(!b||!c)return!1;a.uiUtil().MsgBox(c.IDS_MSGBOX_NOT_SUPPORTED_MEDIA);return!0}function A(b){if(a.CONST.__USFB_M_DISK.device>g||(a.CONST.__USFB_M_DISK.device===g||a.CONST.__USFB_M_HSMKEY.device===g)&&1>n)return a.uiUtil().msgBox(b.IDS_MSGBOX_ERROR_PLEASE_SELECT_STORAGE),!1;if("CERT_COPY"==d.type&&d.args.sourceDevice===g&&d.args.sourceDrive===n)return a.uiUtil().msgBox(b.IDS_MSGBOX_ERROR_WARNING_SAME_STORAGE),!1;if(("CERT_COPY"===d.type||"CERT_IMPORT"===d.type||"CERT_STORAGE"===d.type||"CERT_STORAGE_ISSUE"===d.type)&&a.CONST.__USFB_M_SMARTCARD.device===g&&0===n&&!confirm(b.IDS_CONFIRMBOX_WARNING_CHANGE_CERT))return!1;if(g==a.CONST.__USFB_M_MOBILETOKEN.device)a.nimservice().GetDiskListNumNotDeviceSelect(a.CONST.__USFB_M_MOBILETOKEN.device,function(c){if(0>=c)a.ERROR.Code=210020,a.ERROR.Message=r.IDS_MSGBOX_NOT_INSTALL_SMARTCERT,confirm(r.IDS_CONFIRMBOX_NOT_INSTALL_SMARTCERT)&&(d.onCancel(),null==("firefox"==a.browserName?window.open(a.usimEnv.downloadURL,"usim_url","scrollbars=1, op=100px, left=100px, height=500px, width=380px"):window.open(a.usimEnv.downloadURL,"usim_url","top=100px, left=100px, height=500px, width=380px"))&&a.uiUtil().msgBox(r.IDS_MSGBOX_BLOCK_POPUP_WINDOW));else d.onConfirm(g,n)});else if(g==a.CONST.__USFB_M_MOBILE.device)a.nimservice().SetUBIKeyOptions(function(c){if(11003==c||11004==c)a.ERROR.Code=11003,a.ERROR.Message=r.IDS_MSGBOX_NOT_INSTALL_MOBILE,confirm(r.IDS_CONFIRMBOX_NOT_INSTALL_MOBILE)&&(d.onCancel(),null==("firefox"==a.browserName?window.open(a.ubiKeyEnv.downloadURL,"ubikey_url","scrollbars=1, op=100px, left=100px, height=500px, width=500px"):window.open(a.ubiKeyEnv.downloadURL,"ubikey_url","top=100px, left=100px, height=500px, width=500px"))&&a.uiUtil().msgBox(r.IDS_MSGBOX_BLOCK_POPUP_WINDOW));else d.onConfirm(g,n)});else return d.onConfirm(g,n),!0}function m(b){if(!b)return!1;for(var c=a.ESVS.Media.list.split("|"),d=0;d<c.length;d++){var f=a.CONST.medias[c[d]];void 0!=f&&null!=f&&(f=document.getElementById("us-btn-storage-"+f.name),void 0!=f&&null!=f&&"us-layout-storage-btn-none"!=f.className&&(f.className=b===f?"us-layout-storage-btn-on":"us-layout-storage-btn-off"))}return!0}function B(b){if(null==b||void 0==b)return!1;var c=!a.uiUtil().isItSupportingThisStorage(b);!1==c&&null!=a.ESVS.Media&&null!=a.ESVS.Media.list&&0>a.ESVS.Media.list.indexOf(b.name)&&(c=!0);if(c)return!1;var c=document.getElementById("us-btn-storage-btn-list"),d=document.createElement("li");d.setAttribute("id","us-storage-btn-li-"+b.name,0);d.setAttribute("mediaIndex",b.mediaIndex,0);7==b.mediaIndex&&(d.className="line-first");"hidden"===b.visibility?(d.style.display="none",d.style.visibility="hidden"):(d.style.display="block",d.style.visibility="visible");var f=document.createElement("button");f.setAttribute("type","button",0);f.setAttribute("id","us-btn-storage-"+b.name,0);f.setAttribute("title",b.label,0);f.setAttribute("tabindex",b.tabIndex,0);b.disabled?(f.onclick=function(){a.uiUtil().msgBox(r.IDS_MSGBOX_NOT_SUPPORTED_MEDIA)},f.className="us-layout-storage-btn-none"):(f.onclick=b.onclick,f.className=b.device===g?"us-layout-storage-btn-on":"us-layout-storage-btn-off");d.appendChild(f);if("harddisk"!==b.name&&"webstorage"!==b.name){var h=document.createElement("span");h.className="us-drive-select";f.appendChild(h)}h=document.createElement("span");h.className="us-img-storage";var p=document.createElement("img");p.setAttribute("id","us-img-storage-"+b.name,0);p.setAttribute("alt",b.label,0);b.disabled?p.setAttribute("src",a.ESVS.SRCPath+"unisignweb/rsrc/img/media_"+b.name+"_d.png",0):p.setAttribute("src",a.ESVS.SRCPath+"unisignweb/rsrc/img/media_"+b.name+".png",0);h.appendChild(p);f.appendChild(h);h=document.createElement("span");h.setAttribute("id","us-lbl-storage-"+b.name,0);h.className="us-layout-lbl-storage";h.appendChild(document.createTextNode(b.label));f.appendChild(h);d.appendChild(f);c.appendChild(d);return!0}var C=function(){var b;b=window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0");b.open("GET",a.ESVS.SRCPath+"unisignweb/rsrc/layout/storageselect.html?V="+a.ver,!1);b.send(null);return b.responseText},x=function(){var b;b=window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0");b.open("GET",a.ESVS.SRCPath+"unisignweb/rsrc/lang/storageselect_"+a.ESVS.Language+".js?V="+a.ver,!1);b.send(null);return b.responseText},r=eval(eval(x)()),t=a.ESVS.TabIndex,g=a.CONST.__USFB_M_DISK.device,n=0;null!=a.ESVS.Media&&null!=a.ESVS.Media.defaultdevice?g=a.uiUtil().getMediaDevice(a.ESVS.Media.defaultdevice):2==a.ESVS.Mode&&(g=a.CONST.__PF_M_LS.device);return function(){var b=eval(C),c=eval(eval(x)());v(b());b=document.getElementById("us-storage-select-lbl-title");b.appendChild(document.createTextNode(c.IDS_STORAGE_SELECTION));b.setAttribute("tabindex",t++,0);document.getElementById("us-storage-select-cls-btn-img").setAttribute("src",a.ESVS.SRCPath+"unisignweb/rsrc/img/x-btn.png",0);b=document.getElementById("us-storage-select-notice-lbl");"CERT_STORAGE"===d.type||"CERT_STORAGE_ISSUE"===d.type?b.appendChild(document.createTextNode(c.IDS_SAVE_NOTICE)):b.appendChild(document.createTextNode(c.IDS_COPY_NOTICE));var k=function(){for(var b=0,h=a.ESVS.Media.list.split("|"),k=0;k<h.length;k++){var e=a.CONST.medias[h[k]];if(void 0!=e&&null!=e){switch(e.device){case a.CONST.__USFB_M_DISK.device:e.label=c.IDS_STORAGE_REMOVABLE;e.disabled=2==a.ESVS.Mode;e.onclick=function(){y(this,c);m(this)};break;case a.CONST.__USFB_M_HSMKEY.device:e.label=c.IDS_STORAGE_SECTOKEN;e.disabled=!("win"==a.osName&&2!=a.ESVS.Mode);e.onclick=function(){z(this,c);m(this)};break;case a.CONST.__USFB_M_SMARTCARD.device:e.label=c.IDS_STORAGE_SAVETOKEN;e.disabled=!("win"==a.osName&&2!=a.ESVS.Mode);e.onclick=function(){w(this,c);m(this)};break;case a.CONST.__USFB_M_MOBILE.device:e.label=c.IDS_STORAGE_MOBILEPHONE;e.disabled="CERT_STORAGE"==d.type||"CERT_STORAGE_ISSUE"===d.type?!0:2==a.ESVS.Mode;e.onclick=function(){g=a.CONST.__USFB_M_MOBILE.device;n=0;this.focus();m(this)};break;case a.CONST.__USFB_M_HDD.device:e.label=c.IDS_STORAGE_HARDDISK;e.disabled=2==a.ESVS.Mode;e.onclick=function(){g=a.CONST.__USFB_M_HDD.device;n=0;this.focus();m(this)};break;case a.CONST.__USFB_M_MOBILETOKEN.device:e.label=c.IDS_STORAGE_MOBILETOKEN;e.disabled=2==a.ESVS.Mode;e.onclick=function(){g=a.CONST.__USFB_M_MOBILETOKEN.device;n=0;this.focus();m(this)};break;case a.CONST.__PF_M_LS.device:e.label=c.IDS_STORAGE_LS;e.disabled=1==a.ESVS.Mode||"CERT_COPY"==d.type;e.onclick=function(){g=a.CONST.__PF_M_LS.device;this.focus();m(this)};break;case a.CONST.__PF_M_SS.device:e.label=c.IDS_STORAGE_SS;e.disabled=1==a.ESVS.Mode||"CERT_COPY"==d.type;e.onclick=function(){g=a.CONST.__PF_M_SS.device;this.focus();m(this)};break;case a.CONST.__PF_M_TOUCHSIGN.device:e.label=c.IDS_STORAGE_TOUCHSIGN;e.disabled=!0;e.onclick=function(){u(this,c)};break;case a.CONST.__PF_M_SMARTSIGN.device:e.label=c.IDS_STORAGE_SMARTSIGN;e.disabled=!0;e.onclick=function(){u(this,c)};break;case a.CONST.__PF_M_WEBSECTOKEN.device:e.label=c.IDS_STORAGE_WEBSECTOKEN;e.disabled=!0;e.onclick=function(){u(this,c)};break;case a.CONST.__PF_M_WEBSOFTTOKEN.device:e.label=c.IDS_STORAGE_WEBSOFTTOKEN;e.disabled=!0;e.onclick=function(){u(this,c)};break;case a.CONST.__PF_M_CLOUDSIGN.device:e.label=c.IDS_STORAGE_CLOUDSIGN;e.disabled=1==a.ESVS.Mode;e.onclick=function(){g=a.CONST.__PF_M_CLOUDSIGN.device;this.focus();m(this)};break;default:e.label=c.IDS_STORAGE_ETC,e.disabled=!0,e.onclick=function(){u(this,c)}}e.tabIndex=t;e.mediaIndex=b+1;e.visibility="visible";B(e)&&(t++,b++,1==b&&document.getElementById("us-btn-storage-"+e.name))}}document.getElementById("us-storage-select-warning-lbl").appendChild(document.createTextNode(c.IDS_WARNING));b=document.getElementById("us-storage-select-confirm-btn");b.setAttribute("value",c.IDS_CONFIRM,0);b.setAttribute("title",c.IDS_CONFIRM+c.IDS_BUTTON,0);b.setAttribute("tabindex",t++,0);b.onclick=function(){A(c)};b=document.getElementById("us-storage-select-cancel-btn");b.setAttribute("value",c.IDS_CANCEL,0);b.setAttribute("title",c.IDS_CANCEL+c.IDS_BUTTON,0);b.setAttribute("tabindex",t++,0);b.onclick=function(){d.onCancel()};b=document.getElementById("us-storage-select-cls-img-btn");b.setAttribute("title",c.IDS_STORAGE_SELECTION_CLOSE,0);b.setAttribute("tabindex",t++,0);b.onclick=function(){d.onCancel()}};4&a.ESVS.Mode&&a.nimservice()&&("Enabled"===a.ESVS.UniCRS?a.nimservice().GetAllMediaList(0,function(a,b){k()}):(a.nimservice().GetAllMediaList(1,function(a,b){}),k()));return document.getElementById("us-div-storage-select")}()};return function(d){var v=a.uiLayerLevel,q=a.uiUtil().getOverlay(v),l=w({type:d.type,args:d.args,onConfirm:d.onConfirm,onCancel:d.onCancel});l.style.zIndex=v+1;a.ESVS.TargetObj.insertBefore(q,a.ESVS.TargetObj.firstChild);var s=window.onresize;return{show:function(){draggable(l,document.getElementById("us-div-storage-select-title"));q.style.display="block";a.uiUtil().offsetResize(l);window.onresize=function(){a.uiUtil().offsetResize(l);s&&s()};a.uiLayerLevel+=10;a.ESVS.TabIndex+=30;setTimeout(function(){var a=l.getElementsByTagName("p");if(0<a.length)for(var d=0;d<a.length;d++)"us-storage-select-lbl-title"==a[d].id&&a[d].focus()},10)},hide:function(){q.style.display="none";l.style.display="none"},dispose:function(){window.onresize=function(){s&&s()};"CERT_STORAGE"===d.type||"CERT_STORAGE_ISSUE"===d.type?l.parentNode.removeChild(l):l.parentNode.parentNode.removeChild(l.parentNode);q.parentNode.removeChild(q);a.uiLayerLevel-=10;a.ESVS.TabIndex-=30}}}};