var __crosscertlocalstorage=function(u){function g(a,b,f){var p=JSON.parse(a),c={};c.messageNumber=b;c.operation=p.operation;c.certIdentifier=p.certIdentifier?p.certIdentifier:"";c.callback=f;c.valid=!0;10<=m&&(m=0);k[m]=c;m+=1;e+=1;try{document.getElementById("hsmiframe").contentWindow.postMessage(a,q)}catch(d){null!=f&&f(-1)}}function t(){r--;"function"===typeof window.addEventListener?window.removeEventListener("message",n,!1):window.detachEvent("onmessage",n)}function s(){0<r&&t();"function"===typeof window.addEventListener?window.addEventListener("message",n,!1):window.attachEvent("onmessage",n);r++}var e=0,h=Math.random();ccoperation="GetVersion GetStorageHandler GetCertificateList SaveUserCert SetP12OnMemory DeleteUserCertByIndex IsAvaliable GetP12ForBuToPc GetP12ForBuToMo DeleteUserCertByDN SetP12HexOnMemory".split(" ");var l=!1,c="",d="",m=0,k=[],q=u.ESVS.SHARESTORAGE,r=0,n=function(a){l=!0;if(!(null==a.data||0>=a.data.length)){var b=0,f=null;a=JSON.parse(a.data);for(b=0;b<k.length;b++)if(k[b].messageNumber==a.messageNumber){if(!1==k[b].valid){k[b].callback(-1);return}f=k[b].callback;k[b]=0;break}a.operation==ccoperation[0]?(b=f,currentVersion=a.list[0].version,a=currentVersion.split("."),currentVersion=a[0]+"."+a[1]+"."+a[2]+".0",b(currentVersion)):a.operation==ccoperation[1]?(b=f,0!=a.resultCode?(c=a.resultCode,d=a.resultMessage,b(c,0)):b(a.resultCode,a.PFSH)):a.operation==ccoperation[2]?(b=f,0!=a.resultCode?(c=a.resultCode,d=a.resultMessage,b(c,0)):b(a.resultCode,a.userCerts)):a.operation==ccoperation[3]?(b=f,0!=a.resultCode?(c=a.resultCode,d=a.resultMessage,b(c,0)):b(a.resultCode,a.resultMessage)):a.operation==ccoperation[4]?(b=f,0!=a.resultCode?(c=a.resultCode,d=a.resultMessage,b(c,d)):b(a.resultCode,a.resultMessage,a.userCertsInfo)):a.operation==ccoperation[5]?(b=f,0!=a.resultCode?(c=a.resultCode,d=a.resultMessage,b(c,d)):b(a.resultCode,a.resultMessage)):a.operation==ccoperation[6]?(b=f,0!=a.resultCode?(c=a.resultCode,d=a.resultMessage,b(c,d)):b(a.resultCode,a.resultMessage)):a.operation==ccoperation[7]?(b=f,0!=a.resultCode?(c=a.resultCode,d=a.resultMessage,b(c,d)):b(a.resultCode,a.resultMessage,a.dn,a.p12)):a.operation==ccoperation[8]?(b=f,0!=a.resultCode?(c=a.resultCode,d=a.resultMessage,b(c,d)):b(a.resultCode,a.resultMessage,a.p12key,a.p12)):a.operation==ccoperation[9]?(b=f,0!=a.resultCode?(c=a.resultCode,d=a.resultMessage,b(c,d)):b(a.resultCode,a.resultMessage)):a.operation==ccoperation[10]&&(b=f,0!=a.resultCode?(c=a.resultCode,d=a.resultMessage,b(c,d)):b(a.resultCode,a.resultMessage,a.userCertsInfo))}};(function(a){l=!1;var b=!0,f=function(c,f){b&&(b=!1,c&&c.parentNode&&c.parentNode.removeChild(c),l=f,a(f))},c;-1!=navigator.userAgent.indexOf("MSIE 7.0")?c=document.createElement("<img id='hsmImg' src='"+q+"/logo.png?cd="+Math.random()+"' onload='' onerror='fnResult(this, false)' />"):(c=document.createElement("img"),c.setAttribute("id","hsmImg"),c.setAttribute("src",q+"/logo.png?cd="+Math.random()));c.onerror=function(){f(c,!1)};c.onload=function(){f(c,!0)};c.style.display="none";document.body.appendChild(c);if(-1!=navigator.userAgent.indexOf("MSIE 8")){var e=function(){!1==l?setTimeout(e,100):f(null,!0)};setTimeout(e,100)}})(function(a){if(l=a)a=document.getElementById("hsmiframe"),null!=a&&(a.onload=function(){s()})});s();return{Version:function(a){},GetLastErrorCode:function(){return c},GetLastErrorMessage:function(){return d},IsAvailable:function(){return l},GetIframeLoaded:function(){return l},IsCCPFSHAvailable:function(a){g(JSON.stringify({messageNumber:e,sessionID:""+h,operation:ccoperation[6]}),e,a)},GetCCStorageHandler:function(a,b,c,d){t();s();g(JSON.stringify({messageNumber:e,sessionID:""+h,operation:ccoperation[1],enc_algo:a,hash_algo:b,pki:c}),e,d)},SaveUserCert:function(a,b,c,d){g(JSON.stringify({messageNumber:e,sessionID:""+h,operation:ccoperation[3],caname:a,usercert:b,checkExist:c}),e,d)},GetCertificateList:function(a){g(JSON.stringify({messageNumber:e,sessionID:""+h,operation:ccoperation[2]}),e,a)},SetP12OnMemory:function(a,b,c){g(JSON.stringify({messageNumber:e,sessionID:""+h,operation:ccoperation[4],fileB64Bin:a,pw:b}),e,c)},DeleteUserCertByIndex:function(a,b){g(JSON.stringify({messageNumber:e,sessionID:""+h,operation:ccoperation[5],index:a}),e,b)},GetP12ForBuToPc:function(a,b,c,d){g(JSON.stringify({messageNumber:e,sessionID:""+h,operation:ccoperation[7],index:a,pw:b,retType:c}),e,d)},GetP12ForBuToMo:function(a,b,c){g(JSON.stringify({messageNumber:e,sessionID:""+h,operation:ccoperation[8],index:a,encoding:b}),e,c)},DeleteUserCertByDN:function(a,b,c,d){g(JSON.stringify({messageNumber:e,sessionID:""+h,operation:ccoperation[9],ca:a,dn:b,pw:c}),e,d)},SetP12HexOnMemory:function(a,b,c){g(JSON.stringify({messageNumber:e,sessionID:""+h,operation:ccoperation[10],p12Hex:a,p12Hexkey:b}),e,c)}}};