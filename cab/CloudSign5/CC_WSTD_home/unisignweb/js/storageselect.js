var __storageselect=function(a){var v=function(e){function u(b){if(!b)return alert("UI load error."),!1;if("CERT_STORAGE"===e.type||"CERT_STORAGE_ISSUE"===e.type)a.ESVS.TargetObj.innerHTML=b;else{var d=document.createElement("div");document.body.insertBefore(d,document.body.firstChild);d.innerHTML=b}return!0}function h(b,d,k){if(a.CONST.__USFB_M_DISK.device>b||!d||!k)return!1;var f=a.loadUI("driveselect")({type:"DEVICE_REMOVABLE_DISK",args:d,onConfirm:function(a){g=b;m=a;f.dispose();k.focus()},onCancel:function(){f.dispose();k.focus()}});f.show()}function l(b,d,k,f){var c=a.loadUI("sectokenselect")({type:b,args:d,onConfirm:function(d,l){g=b;m=d;"CERT_STORAGE_ISSUE"==e.type&&-1!=l.indexOf("BIO")?a.uiUtil().msgBox(f.IDS_MSGBOX_BLOCK_BIOTOKEN_FORISSUE):(c.dispose(),k.focus())},onCancel:function(){c.dispose();k.focus()}});c.show()}function r(b,d,k){if(a.CONST.__USFB_M_DISK.device>b||!driveList||!k)return!1;var f=a.loadUI("driveselect")({type:"DEVICE_SAVE_TOKEN",args:d,onConfirm:function(a){g=b;m=a;f.dispose();k.focus()},onCancel:function(){f.dispose();k.focus()}});f.show()}function x(b,d){var k=null;m=g=0;if(1===a.ESVS.Mode)if(a.plugin().valid){var f=a.plugin().GetDiskListNum();if(0<f){for(var c=[],e=0;e<f;e++){var l=e+1,p={};p.index=l;p.name=a.plugin().GetDiskDriveName(l);c[e]=p}k={list:c}}else a.plugin().GetLastErrorCode()}else return a.uiUtil().msgBox(d.IDS_MSGBOX_PLUGIN_ERROR_UNLOAD),!1;else if(4&a.ESVS.Mode)if(a.nimservice())a.nimservice().GetDiskListNum(a.CONST.__USFB_M_DISK.device,function(c){if(0<c){for(var d=[],f=0;f<c;f++){var e=f+1,g={};g.index=e;g.name=a.nimservice().GetDiskDriveName(e);d[f]=g}k={list:d}}else a.nimservice().GetLastErrorCode();h(a.CONST.__USFB_M_DISK.device,k,b)});else return a.uiUtil().msgBox(__text.IDS_MSGBOX_NIM_ERROR_UNLOAD),!1;4&a.ESVS.Mode||h(a.CONST.__USFB_M_DISK.device,k,b);return!0}function y(b,d){var k=null;m=g=0;if(1&a.ESVS.Mode)if(a.plugin().valid){var f=[],c=a.plugin().GetHSMInstallListNum();if(0<c)for(var e=0;e<c;e++){var n=e+1,p={},h=a.plugin().GetHSMInstallDriverName(n).split("|");p.index=n;p.name=h[0];p.driver=h[1];p.passage=h[2];p.validity=h[3];f[e]=p}k={list:f}}else return a.uiUtil().msgBox(d.IDS_MSGBOX_PLUGIN_ERROR_UNLOAD),!1;else if(4&a.ESVS.Mode)if(a.nimservice())a.nimservice().GetDiskListNum(a.CONST.__USFB_M_HSMKEY.device,function(c){if(0<c){for(var f=[],e=0;e<c;e++){var g=e+1,h={},m=a.nimservice().GetSecureTokenName(g).split("|");h.index=g;h.name=m[0];h.driver=m[1];h.passage=m[2];f[e]=h}k={list:f}}else a.nimservice().GetLastErrorCode();l(a.CONST.__USFB_M_HSMKEY.device,k,b,d)});else return a.uiUtil().msgBox(__text.IDS_MSGBOX_NIM_ERROR_UNLOAD),!1;4&a.ESVS.Mode||l(a.CONST.__USFB_M_HSMKEY.device,k,b,d);return!0}function v(b,d){m=g=0;if(4&a.ESVS.Mode)if(a.nimservice())a.nimservice().GetDiskListNum(a.CONST.__USFB_M_SMARTCARD.device,function(d){if(0<d){for(var f=[],c=0;c<d;c++){var e=c+1,g={};g.index=e;g.name=a.nimservice().GetSmartCardName(e);f[c]=g}driveList={list:f}}else return-1===d&&(d=a.nimservice().GetLastErrorCode(),f=a.nimservice().GetLastErrorMessage(),console.log("***** GetCertsFromRemovable *****"),console.log("Err Code : ",d,"\nErr Msg : ",f)),a.certsList=null,!1;r(a.CONST.__USFB_M_SMARTCARD.device,driveList,b)});else return a.uiUtil().msgBox(__text.IDS_MSGBOX_NIM_ERROR_UNLOAD),!1}function t(b,d){if(!b||!d)return!1;a.uiUtil().MsgBox(d.IDS_MSGBOX_NOT_SUPPORTED_MEDIA);return!0}function z(b){if(a.CONST.__USFB_M_DISK.device>g||(a.CONST.__USFB_M_DISK.device===g||a.CONST.__USFB_M_HSMKEY.device===g)&&1>m)return a.uiUtil().msgBox(b.IDS_MSGBOX_ERROR_PLEASE_SELECT_STORAGE),!1;if("CERT_COPY"==e.type&&e.args.sourceDevice===g&&e.args.sourceDrive===m)return a.uiUtil().msgBox(b.IDS_MSGBOX_ERROR_WARNING_SAME_STORAGE),!1;if(("CERT_COPY"===e.type||"CERT_IMPORT"===e.type||"CERT_STORAGE"===e.type||"CERT_STORAGE_ISSUE"===e.type)&&a.CONST.__USFB_M_SMARTCARD.device===g&&0===m&&!confirm(b.IDS_CONFIRMBOX_WARNING_CHANGE_CERT))return!1;if(g==a.CONST.__USFB_M_MOBILETOKEN.device)a.nimservice().GetDiskListNum(a.CONST.__USFB_M_MOBILETOKEN.device,function(b){if(0>=b)a.ERROR.Code=210020,a.ERROR.Message=q.IDS_MSGBOX_NOT_INSTALL_SMARTCERT,confirm(q.IDS_CONFIRMBOX_NOT_INSTALL_SMARTCERT)&&(e.onCancel(),null==("firefox"==a.browserName?window.open(a.usimEnv.downloadURL,"usim_url","scrollbars=1, op=100px, left=100px, height=500px, width=380px"):window.open(a.usimEnv.downloadURL,"usim_url","top=100px, left=100px, height=500px, width=380px"))&&a.uiUtil().msgBox(q.IDS_MSGBOX_BLOCK_POPUP_WINDOW));else e.onConfirm(g,m)});else if(g==a.CONST.__USFB_M_MOBILE.device)a.nimservice().SetUBIKeyOptions(function(b){if(11003==b||11004==b)a.ERROR.Code=11003,a.ERROR.Message=q.IDS_MSGBOX_NOT_INSTALL_MOBILE,confirm(q.IDS_CONFIRMBOX_NOT_INSTALL_MOBILE)&&(e.onCancel(),null==("firefox"==a.browserName?window.open(a.ubiKeyEnv.downloadURL,"ubikey_url","scrollbars=1, op=100px, left=100px, height=500px, width=500px"):window.open(a.ubiKeyEnv.downloadURL,"ubikey_url","top=100px, left=100px, height=500px, width=500px"))&&a.uiUtil().msgBox(q.IDS_MSGBOX_BLOCK_POPUP_WINDOW));else e.onConfirm(g,m)});else return e.onConfirm(g,m),!0}function n(b){if(!b)return!1;for(var d=a.ESVS.Media.list.split("|"),e=0;e<d.length;e++){var f=a.CONST.medias[d[e]];void 0!=f&&null!=f&&(f=document.getElementById("us-btn-storage-"+f.name),void 0!=f&&null!=f&&"us-layout-storage-btn-none"!=f.className&&(f.className=b===f?"us-layout-storage-btn-on":"us-layout-storage-btn-off"))}return!0}function A(b){if(null==b||void 0==b)return!1;var d=!a.uiUtil().isItSupportingThisStorage(b);!1==d&&null!=a.ESVS.Media&&null!=a.ESVS.Media.list&&0>a.ESVS.Media.list.indexOf(b.name)&&(d=!0);if(d)return!1;var d=document.getElementById("us-btn-storage-btn-list"),e=document.createElement("li");e.setAttribute("id","us-storage-btn-li-"+b.name,0);e.setAttribute("mediaIndex",b.mediaIndex,0);7==b.mediaIndex&&(e.className="line-first");"hidden"===b.visibility?(e.style.display="none",e.style.visibility="hidden"):(e.style.display="block",e.style.visibility="visible");var f=document.createElement("button");f.setAttribute("type","button",0);f.setAttribute("id","us-btn-storage-"+b.name,0);f.setAttribute("title",b.label,0);f.setAttribute("tabindex",b.tabIndex,0);b.disabled?(f.onclick=function(){a.uiUtil().msgBox(q.IDS_MSGBOX_NOT_SUPPORTED_MEDIA)},f.className="us-layout-storage-btn-none"):(f.onclick=b.onclick,f.className=b.device===g?"us-layout-storage-btn-on":"us-layout-storage-btn-off");e.appendChild(f);if("harddisk"!==b.name&&"webstorage"!==b.name){var c=document.createElement("span");c.className="us-drive-select";f.appendChild(c)}c=document.createElement("span");c.className="us-img-storage";var h=document.createElement("img");h.setAttribute("id","us-img-storage-"+b.name,0);h.setAttribute("alt",b.label,0);b.disabled?h.setAttribute("src",a.ESVS.SRCPath+"unisignweb/rsrc/img/media_"+b.name+"_d.png",0):h.setAttribute("src",a.ESVS.SRCPath+"unisignweb/rsrc/img/media_"+b.name+".png",0);c.appendChild(h);f.appendChild(c);c=document.createElement("span");c.setAttribute("id","us-lbl-storage-"+b.name,0);c.className="us-layout-lbl-storage";c.appendChild(document.createTextNode(b.label));f.appendChild(c);e.appendChild(f);d.appendChild(e);return!0}var B=function(){var b;b=window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0");b.open("GET",a.ESVS.SRCPath+"unisignweb/rsrc/layout/storageselect.html?version="+a.ver,!1);b.send(null);return b.responseText},w=function(){var b;b=window.XMLHttpRequest?new window.XMLHttpRequest:new ActiveXObject("MSXML2.XMLHTTP.3.0");b.open("GET",a.ESVS.SRCPath+"unisignweb/rsrc/lang/storageselect_"+a.ESVS.Language+".js?version="+a.ver,!1);b.send(null);return b.responseText},q=eval(eval(w)()),s=a.ESVS.TabIndex,g=a.CONST.__USFB_M_DISK.device,m=0;null!=a.ESVS.Media&&null!=a.ESVS.Media.defaultdevice?g=a.uiUtil().getMediaDevice(a.ESVS.Media.defaultdevice):2==a.ESVS.Mode&&(g=a.CONST.__PF_M_LS.device);return function(){var b=eval(B),d=eval(eval(w)());u(b());b=document.getElementById("us-storage-select-lbl-title");b.appendChild(document.createTextNode(d.IDS_STORAGE_SELECTION));b.setAttribute("tabindex",s++,0);document.getElementById("us-storage-select-cls-btn-img").setAttribute("src",a.ESVS.SRCPath+"unisignweb/rsrc/img/x-btn.png",0);b=document.getElementById("us-storage-select-notice-lbl");"CERT_STORAGE"===e.type||"CERT_STORAGE_ISSUE"===e.type?b.appendChild(document.createTextNode(d.IDS_SAVE_NOTICE)):b.appendChild(document.createTextNode(d.IDS_COPY_NOTICE));4&a.ESVS.Mode&&a.nimservice()&&("Enabled"===a.ESVS.UniCRS?a.nimservice().GetAllMediaList(0,function(a,b){}):a.nimservice().GetAllMediaList(1,function(a,b){}));for(var b=0,h=a.ESVS.Media.list.split("|"),f=0;f<h.length;f++){var c=a.CONST.medias[h[f]];if(void 0!=c&&null!=c){switch(c.device){case a.CONST.__USFB_M_DISK.device:c.label=d.IDS_STORAGE_REMOVABLE;c.disabled=2==a.ESVS.Mode;c.onclick=function(){x(this,d);n(this)};break;case a.CONST.__USFB_M_HSMKEY.device:c.label=d.IDS_STORAGE_SECTOKEN;c.disabled=!("win"==a.osName&&2!=a.ESVS.Mode);c.onclick=function(){y(this,d);n(this)};break;case a.CONST.__USFB_M_SMARTCARD.device:c.label=d.IDS_STORAGE_SAVETOKEN;c.disabled=!("win"==a.osName&&2!=a.ESVS.Mode);c.onclick=function(){v(this,d);n(this)};break;case a.CONST.__USFB_M_MOBILE.device:c.label=d.IDS_STORAGE_MOBILEPHONE;c.disabled="CERT_STORAGE"==e.type||"CERT_STORAGE_ISSUE"===e.type?!0:2==a.ESVS.Mode;c.onclick=function(){g=a.CONST.__USFB_M_MOBILE.device;this.focus();n(this)};break;case a.CONST.__USFB_M_HDD.device:c.label=d.IDS_STORAGE_HARDDISK;c.disabled=2==a.ESVS.Mode;c.onclick=function(){g=a.CONST.__USFB_M_HDD.device;this.focus();n(this)};break;case a.CONST.__USFB_M_MOBILETOKEN.device:c.label=d.IDS_STORAGE_MOBILETOKEN;c.disabled=2==a.ESVS.Mode;c.onclick=function(){g=a.CONST.__USFB_M_MOBILETOKEN.device;this.focus();n(this)};break;case a.CONST.__PF_M_LS.device:c.label=d.IDS_STORAGE_LS;c.disabled=1==a.ESVS.Mode||"CERT_COPY"==e.type;c.onclick=function(){g=a.CONST.__PF_M_LS.device;this.focus();n(this)};break;case a.CONST.__PF_M_SS.device:c.label=d.IDS_STORAGE_SS;c.disabled=1==a.ESVS.Mode||"CERT_COPY"==e.type;c.onclick=function(){g=a.CONST.__PF_M_SS.device;this.focus();n(this)};break;case a.CONST.__PF_M_TOUCHSIGN.device:c.label=d.IDS_STORAGE_TOUCHSIGN;c.disabled=!0;c.onclick=function(){t(this,d)};break;case a.CONST.__PF_M_SMARTSIGN.device:c.label=d.IDS_STORAGE_SMARTSIGN;c.disabled=!0;c.onclick=function(){t(this,d)};break;case a.CONST.__PF_M_WEBSECTOKEN.device:c.label=d.IDS_STORAGE_WEBSECTOKEN;c.disabled=!0;c.onclick=function(){t(this,d)};break;case a.CONST.__PF_M_WEBSOFTTOKEN.device:c.label=d.IDS_STORAGE_WEBSOFTTOKEN;c.disabled=!0;c.onclick=function(){t(this,d)};break;case a.CONST.__PF_M_CLOUDSIGN.device:c.label=d.IDS_STORAGE_CLOUDSIGN;c.disabled=1==a.ESVS.Mode;c.onclick=function(){g=a.CONST.__PF_M_CLOUDSIGN.device;this.focus();n(this)};break;default:c.label=d.IDS_STORAGE_ETC,c.disabled=!0,c.onclick=function(){t(this,d)}}c.tabIndex=s;c.mediaIndex=b+1;c.visibility="visible";A(c)&&(s++,b++,1==b&&document.getElementById("us-btn-storage-"+c.name))}}document.getElementById("us-storage-select-warning-lbl").appendChild(document.createTextNode(d.IDS_WARNING));b=document.getElementById("us-storage-select-confirm-btn");b.setAttribute("value",d.IDS_CONFIRM,0);b.setAttribute("title",d.IDS_CONFIRM+d.IDS_BUTTON,0);b.setAttribute("tabindex",s++,0);b.onclick=function(){z(d)};b=document.getElementById("us-storage-select-cancel-btn");b.setAttribute("value",d.IDS_CANCEL,0);b.setAttribute("title",d.IDS_CANCEL+d.IDS_BUTTON,0);b.setAttribute("tabindex",s++,0);b.onclick=function(){e.onCancel()};b=document.getElementById("us-storage-select-cls-img-btn");b.setAttribute("title",d.IDS_STORAGE_SELECTION_CLOSE,0);b.setAttribute("tabindex",s++,0);b.onclick=function(){e.onCancel()};return document.getElementById("us-div-storage-select")}()};return function(e){var u=a.uiLayerLevel,h=a.uiUtil().getOverlay(u),l=v({type:e.type,args:e.args,onConfirm:e.onConfirm,onCancel:e.onCancel});l.style.zIndex=u+1;a.ESVS.TargetObj.insertBefore(h,a.ESVS.TargetObj.firstChild);var r=window.onresize;return{show:function(){draggable(l,document.getElementById("us-div-storage-select-title"));h.style.display="block";a.uiUtil().offsetResize(l);window.onresize=function(){a.uiUtil().offsetResize(l);r&&r()};a.uiLayerLevel+=10;a.ESVS.TabIndex+=30;setTimeout(function(){var a=l.getElementsByTagName("p");if(0<a.length)for(var e=0;e<a.length;e++)"us-storage-select-lbl-title"==a[e].id&&a[e].focus()},10)},hide:function(){h.style.display="none";l.style.display="none"},dispose:function(){window.onresize=function(){r&&r()};"CERT_STORAGE"===e.type||"CERT_STORAGE_ISSUE"===e.type?l.parentNode.removeChild(l):l.parentNode.parentNode.removeChild(l.parentNode);h.parentNode.removeChild(h);a.uiLayerLevel-=10;a.ESVS.TabIndex-=30}}}};