<script type="text/javascript" src="/cab/realgrid/realgridjs-lic.js"></script>
<script type="text/javascript" src="/cab/realgrid/realgridjs.1.1.24.min.js"></script>
<script type="text/javascript" src="/cab/realgrid/realgridjs-api.1.1.24.js"></script>
<script type="text/javascript" src="/cab/realgrid/jszip.min.js"></script>
<script type="text/javascript" src="/cab/realgrid/import/shim.js"></script>
<script type="text/javascript" src="/cab/realgrid/import/xlsx.js"></script>

<form name="form1" method="post">
	<input type="hidden" name="grid" />
</form>

<div class="div_table">
	<div class="util-row">
		<div class="push-left">
			<h3>크레탑 정보</h3>
		</div>
		<div class="push-right">
			※ 엑셀다운로드를 한 파일에 크레탑 정보를 입력 후 업로드 하세요 (단위:천원)
		</div>
	</div>
	<div class="util-row">
		<div class="push-right">
			<div style="z-index:10;position: relative; float: left; top:3px;left:250px;opacity:0;" class=" auth_css"><input type="file" name="upload_xls" style="width:140px; cursor:pointer;" onchange="excelRead();this.value='';"></div>
			<button type="button" class="sbtn color ico-download" onclick="fDownXLS();"><span></span>엑셀다운로드</button>
			<button type="button" class="sbtn color ico-save auth_css"><span></span>엑셀업로드</button>
		</div>
	</div>
	<table width="100%" border="0" cellpadding="0" cellspacing="0">
	<tr>
		<td align="center">
			<div id="realgrid" style="width: 100%; height: 400px;"></div>
		</td>
	</tr>
	</table>
	<div class="btn-group-wrap">
		<!-- IF START 'rfile' -->
		<button type="button" class="btn color ico-save auth_css" onClick="fSaveItem();"><span></span>크레탑정보 등록</button>
		<button type="button" class="btn color ico-list" onClick="location.href='add_cust_list.jsp?{{list_query}}'"><span></span>목록으로</button>
	</div>
</div>

<script language="javascript">
var dataProvider = null;
var gridView = null;
$(document).ready( function(){
	RealGridJS.setRootContext("{{realgrid_path}}");
	dataProvider = new RealGridJS.LocalDataProvider();
	gridView = new RealGridJS.GridView("realgrid");
	gridView.setDataSource(dataProvider);
	setOptions();
	setStyle();
	setColumns();
	//loadData();
});

function setOptions() {
	var options =  {
		hideDeletedRows : true,
		indicator:{visible: false }
		,panel: {visible: false}
		,footer: {visible: true}
        ,edit: {
            enterToTab: true,
            insertable: true,
            appendable: true,
            updatable: true,
            deletable: true,
            deleteRowsConfirm: true
        }
		,checkBar: {visible: false}
		,stateBar: {visible: false}
		,displayOptions:{
			//columnWidth : 200
		}
		,fitStyle: "evenFill"
	};
	gridView.setOptions(options);

	gridView.onCellEdited =  function (grid, itemIndex, dataRow, field) {
		var field_name = dataProvider.getFieldName(field);
		if(inArray(field_name.toLowerCase() , ["item_cnt","stuff_amt","labor_amt","upkeep_amt"])){
			gridView.commit();
			setTotAmt();
		}

	};
};

function setStyle(){
	$.getJSON("/cab/realgrid/resource/buyer_style.json", function (data, textStatus, jqXHR) {
		gridView.setStyles(data);
	})
		.done(function (data, textStatus, jqXHR) {
			gridView.setFocus();
		})
		.fail(function (jqxhr, textStatus, error) {
			var err = textStatus + ', ' + error;
			var msg = "gridView failStyleSet: " + err;
			console && console.log(msg);
			alert(msg);

		});
}

function setColumns() {
	var columns = [];
    columns.push({name:"vendcd" ,fieldName:"vendcd" ,header:"사업자번호" ,width: 80 ,editable:true , movable:false ,sortable:false, visible:true});
    columns.push({name:"setup_date" ,fieldName:"setup_date" ,header:"설립일자" ,width: 80 ,editable:true , movable:false ,sortable:false, visible:true});
    columns.push({name:"worker_num" ,fieldName:"worker_num" ,header:"인력수" ,width: 80 ,editable:false , movable:false ,sortable:false, visible:true});
    columns.push({name:"major_cust" ,fieldName:"major_cust" ,header:"주요주주(지분율)" ,width: 100 ,editable:false , movable:false ,sortable:false, visible:true});
    columns.push({name:"sales_amt" ,fieldName:"sales_amt" ,header:"매출" ,width: 80 ,editable:false , movable:false ,sortable:false, visible:true});
    columns.push({name:"biz_profit" ,fieldName:"biz_profit" ,header:"영억이익" ,width: 80 ,editable:false , movable:false ,sortable:false, visible:true});
    columns.push({name:"net_profit" ,fieldName:"net_profit" ,header:"당기순이익" ,width: 80 ,editable:false , movable:false ,sortable:false, visible:true});
    columns.push({name:"asset" ,fieldName:"asset" ,header:"자산총계" ,width: 80 ,editable:false , movable:false ,sortable:false, visible:true});
    columns.push({name:"capital" ,fieldName:"capital" ,header:"자본총계" ,width: 80 ,editable:false , movable:false ,sortable:false, visible:true});
    columns.push({name:"debt" ,fieldName:"debt" ,header:"부채총계" ,width: 80 ,editable:false , movable:false ,sortable:false, visible:true});
    columns.push({name:"liquid_asset" ,fieldName:"liquid_asset" ,header:"유동자산" ,width: 80 ,editable:false , movable:false ,sortable:false, visible:true});
    columns.push({name:"liquid_debt" ,fieldName:"liquid_debt" ,header:"유동부채" ,width: 80 ,editable:false , movable:false ,sortable:false, visible:true});
    columns.push({name:"credit_rating" ,fieldName:"credit_rating" ,header:"신용등급" ,width: 80 ,editable:false , movable:false ,sortable:false, visible:true});
    columns.push({name:"tax_delay_yn" ,fieldName:"tax_delay_yn" ,header:"세금체납" ,width: 80 ,editable:false , movable:false ,sortable:false, visible:true});

    dataProvider.setFields(columns);
	gridView.setColumns(columns);	// 컬럼을 TreeView에 입력
    gridView.addCellRenderers(
		[{
			"id": "chk_use_yn",
			"type": "check",
			"shape": "box",
			"editable": true,
			"trueValues": "Y",
			"falseValues": "N",
		}]
	);
}

function excelRead(){
    var files;
    if(window.event.target)
        files = window.event.target.files;
    else if(window.event.srcElement)
        files = window.event.srcElement.files;

    if(!files) {
        alert("내역업로드 기능은 Internet Explorer 10 이상 또는 크롬(chrome)에서만 이용하실 수 있습니다.");
        return true;
    }

    var i, f;
    for (i = 0, f = files[i]; i != files.length; ++i) {
        var reader = new FileReader();
        var name = f.name;
        reader.onload = function (e) {
            var data = e.target.result;
            //var workbook = XLSX.read(data, { type: 'binary' });
            var arr = fixdata(data);
            workbook = XLSX.read(btoa(arr), { type: 'base64' });
            process_wb(workbook);
            /* DO SOMETHING WITH workbook HERE */
        };
        //reader.readAsBinaryString(f);
        reader.readAsArrayBuffer(f);
    }
}

function fixdata(data) {
    var o = "", l = 0, w = 10240;
    for (; l < data.byteLength / w; ++l) o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w, l * w + w)));
    o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w)));
    return o;
}

function process_wb(wb) {
    var output = "";
    output = to_json(wb);

    var sheetNames = Object.keys(output);
    if(!sheetNames){
        alert("형식에 맞지 않는 파일입니다.\n\n업로드 파일을 확인 하세요.");
        return;
    }
    if (sheetNames.length > 0) {
        try {
            output[sheetNames][0];
        } catch (e) {
            alert("형식에 맞지 않는 파일입니다.\n\n업로드 파일을 확인 하세요.");
            return;
        }
        var colObj = output[sheetNames][0];
        var rows = output[sheetNames];
        var read_start_row = 1;
        var grid_row = 0;

        dataProvider.removeRows(dataProvider.getRows(0, dataProvider.getRowCount()));
        var values;
        for (var i = read_start_row; i < rows.length; i++, grid_row++) {
            var row = rows[i];
            values = [row["A"].toString().trim(), row["B"].toString().trim(), row["C"].toString().trim(), row["D"].toString().trim()
			,row["E"].toString().trim(), row["F"].toString().trim(), row["G"].toString().trim(), row["H"].toString().trim(), row["I"].toString().trim()
			,row["J"].toString().trim(), row["K"].toString().trim(), row["L"].toString().trim(), row["M"].toString().trim(), row["N"].toString().trim()];
            dataProvider.insertRow(grid_row, values);
        }

    }
}

function to_json(workbook) {
    var result = {};
    workbook.SheetNames.forEach(
        function (sheetName) {
            var roa = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[sheetName], { header: "A" });
            if (roa.length > 0) {
                result[sheetName] = roa;
            }
        }
    );
    return result;
}

function fDownXLS(){
	 gridView.exportGrid({
	        type: "excel",
	        target: "local",
	        fileName: "크레탑정보.xlsx",
	        showProgress: false,
	        applyDynamicStyles: false,
	        progressMessage: "다운로드 진행 중입니다.",
	        indicator: "hidden",
	        header: "visible",
	        footer: "hidden",
	        compatibility: "2007",
	        done: function () {  //내보내기 완료 후 실행되는 함수
	        }
	    });
}

function fSaveItem() {
    var f = document.forms['form1'];
    var grid_string = "";
    if(dataProvider.getRowCount()>0){
        var jRowsData =  dataProvider.getJsonRows();
        grid_string = encodeURIComponent(JSON.stringify(jRowsData));
        f['grid'].value = grid_string;
    }
    f.action = "cretop_insert_a.jsp";
    f.submit();
}
</script>