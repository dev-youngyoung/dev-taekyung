<script type="text/javascript" src="/cab/realgrid/realgridjs-lic.js"></script>
<script type="text/javascript" src="/cab/realgrid/realgridjs.1.1.24.min.js"></script>
<script type="text/javascript" src="/cab/realgrid/realgridjs-api.1.1.24.js"></script>
<script type="text/javascript" src="/cab/realgrid/jszip.min.js"></script>
<script type="text/javascript" src="/cab/realgrid/import/shim.js"></script>
<script type="text/javascript" src="/cab/realgrid/import/xlsx.js"></script>

<form novalidate name="form1" method="post" onsubmit="return formSubmit(this)">
<input type="hidden" name="data">
<!-- IFNOT START 'modify' -->
<input type="hidden" name="mode" value="new">
<!-- IFNOT END 'modify' -->

    <div class="div_table">
        <div class="util-row">
            <div class="push-left">
                <h3>협력사평가정보</h3>
            </div>
        </div>
        <table>
            <colgroup>
                <col width="15%">
                <col width="35%">
                <col width="15%">
                <col width="35%">
            </colgroup>
            <tr>
                <th class="req-check">기준년월</th>
                <td>
                    <input type="text" id="yyyymm" name="yyyymm" maxlength="6" onkeydown="num_only()" style="width: 100px;ime-mode:disabled;" <!-- IF START 'yyyymm' -->class="in_readonly" readonly<!-- IF END 'yyyymm' -->/>
                </td>
                <th>상태</th>
                <td>{{evaluate.status_nm}}</td>
            </tr>
        </table>
        <br/>
        
        <div class="util-row">
        <div class="push-right" style="z-index:1">
                <button type="button" name="btn_close" class="sbtn color ico-download" value="엑셀다운" onClick="javascript:excelDown();"><span></span>엑셀다운</button>
                <!-- IFNOT START 'evaluate.end_yn' -->
                <div style="z-index:10;position: relative; float: left; top:3px;left:210px;opacity:0;"><input type="file" name="upload_xls" style="width:120px; cursor:pointer;" onchange="excelRead();this.value='';"></div>
                <button type="button" name="btn_close" class="sbtn color ico-save auth_css" value="엑셀업로드" onclick="excelRead();"><span></span>엑셀업로드</button>
                <!-- IFNOT END 'evaluate.end_yn' -->
                
            </div>
        </div>
        <div id="realgrid" style="width: 100%; height: 400px;"></div>

        <div class="btn-group-wrap">
            <!-- IFNOT START 'evaluate.end_yn' -->
            <button type="submit" class="btn color ico-save" ><span></span> 저장</button>
            <!-- IF START 'modify' -->
            <button type="button" class="btn color ico-save" onclick="if(confirm('삭제하시겠습니까?')){location.href='./samsong_evaluate_delete.jsp?{{query}}'}"><span></span> 삭제</button>
            <button type="button" class="btn color ico-confirm auth_css" onclick="if(confirm('확정처리하시겠습니까?')){location.href='./samsong_evaluate_end.jsp?{{query}}'}"><span></span>확정</button>
            <!-- IF END 'modify' -->
            <!-- IFNOT END 'evaluate.end_yn' -->
            <button type="button" name="btn_close" class="btn color ico-list" value="목록으로" onclick="location.href = 'samsong_evaluate_list.jsp?{{list_query}}';"><span></span>목록으로</button>
        </div>

    </div>
</form>

{{form_script}}



<script type="text/javascript">

    var dataProvider = null;
    var gridView = null;
    $(document).ready( function(){
        RealGridJS.setRootContext("{{realgrid_path}}");   //  cab/realgrid
        RealGridJS.setTrace(false);
        dataProvider = new RealGridJS.LocalDataProvider();
        gridView = new RealGridJS.GridView("realgrid");
        gridView.setDataSource(dataProvider);

        setOptions();
        setStyle();
        setColumns();
        loadData();
    });

    function excelRead(){
        var files;
        if(window.event.target){
            files = window.event.target.files;
        }else if(window.event.srcElement){
            files = window.event.srcElement.files;
        }

        if(!files) {
            alert("내역업로드 기능은 Internet Explorer 10 이상 또는 크롬(chrome)에서만 이용하실 수 있습니다.");
            return true;
        }

        var i, f;
        for (i = 0, f = files[i]; i != files.length; ++i) {
            var reader = new FileReader();
            var name = f.name;
            reader.onload = function (e) {
                var data = e.target.result;
                //var workbook = XLSX.read(data, { type: 'binary' });
                var arr = fixdata(data);
                workbook = XLSX.read(btoa(arr), { type: 'base64' });
                process_wb(workbook);
                /* DO SOMETHING WITH workbook HERE */
            };
            //reader.readAsBinaryString(f);
            reader.readAsArrayBuffer(f);
        }
    }

    function fixdata(data) {
        var o = "", l = 0, w = 10240;
        for (; l < data.byteLength / w; ++l) o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w, l * w + w)));
        o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w)));
        return o;
    }

    function process_wb(wb) {

        var output = "";
        output = to_json(wb);

        var sheetNames = Object.keys(output);
        if(!sheetNames){
            alert("형식에 맞지 않는 파일입니다.\n\n업로드 파일을 확인 하세요.");
            return;
        }
        if(sheetNames.length > 0) {

            try {
                output[sheetNames][0];
            } catch (e) {
                alert("형식에 맞지 않는 파일입니다.\n\n업로드 파일을 확인 하세요.");
                return;
            }

            var rows = output[sheetNames];
            var read_start_row = 1;
            var grid_row = 0;
            var data = [];

            for (var i = read_start_row; i < rows.length; i++, grid_row++) {
                var row = rows[i];
                var rowdata={};
                rowdata["vendcd"] = row["A"].toString().trim();
                rowdata["member_name"] = row["B"].toString().trim();
                rowdata["q_point"] = row["C"].toString().trim();
                rowdata["s_point"] = row["D"].toString().trim();
                rowdata["t_point"] = row["E"].toString().trim();
                data.push(rowdata);
            }
            dataProvider.setRows(data);
            gridView.closeProgress();
        }
        //alert("협력사평가정보파일이 업로드 되었습니다.");
    }

    function to_json(workbook) {
        var result = {};
        workbook.SheetNames.forEach(
            function (sheetName) {
                var roa = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[sheetName], { header: "A" });
                if (roa.length > 0) {
                    result[sheetName] = roa;
                }
            }
        );
        return result;
    }

    // 엑셀 다운
    function excelDown(){

        gridView.exportGrid({
            type: "excel",
            target: "local",
            fileName: "협력사평가정보관리.xlsx",
            showProgress: true,
            applyDynamicStyles: false,
            progressMessage: "다운로드 진행 중입니다.",
            indicator: "hidden",
            header: "visible",
            footer: "hidden",
            compatibility: "2007",
            done: function () {  //내보내기 완료 후 실행되는 함수
                // preview();
            }
        });
    }

    function setOptions() {
        var options =  {
            hideDeletedRows : true,
            indicator:{visible: false }
            ,panel: {visible: false}
            ,footer: {visible: false}
            ,checkBar: {visible: false}
            ,stateBar: {visible: false}
            ,edit: {
                enterToTab: true,
                insertable: true,
                appendable: true,
                updatable: true,
                deletable: true,
                deleteRowsConfirm: true,
                deleteRowsMessage: "삭제하시겠습니까 ?"
            }
            ,displayOptions:{
                //columnWidth : 200
            }
        };
        gridView.setOptions(options);

    };

    function setStyle(){
        $.getJSON("/cab/realgrid/resource/buyer_style.json", function (data, textStatus, jqXHR) {
            gridView.setStyles(data);
            $('.codeview.realtreestyle').html(
                JSON.stringify(data, null, 4)
            );
        })
            .done(function (data, textStatus, jqXHR) {
                gridView.setFocus();
            })
            .fail(function (jqxhr, textStatus, error) {
                var err = textStatus + ', ' + error;
                var msg = "gridView failStyleSet: " + err;
                console && console.log(msg);
                alert(msg);

            });
    }

    function setColumns() {

        var columns = [];
        columns.push({name:"vendcd" ,fieldName:"vendcd" ,header:"사업자번호" ,width:200 ,editable:true ,movable:false ,sortable:true, visible:true,readOnly:false,styles :{textAlignment : "center"}});
        columns.push({name:"member_name" ,fieldName:"member_name" ,header:"업체명" ,width:200 ,editable:true ,movable:false ,sortable:true, visible:true,readOnly:false,styles :{textAlignment : "center"}});
        columns.push({name:"q_point" ,fieldName:"q_point" ,header:"품질(Q) 평점" ,width:100 ,editable:true ,movable:false ,sortable:true, visible:true,readOnly:false,dataType:"number",styles:{textAlignment:"far" ,numberFormat:"###.#"}});
        columns.push({name:"s_point" ,fieldName:"s_point" ,header:"서비스(S) 평점" ,width:100 ,editable:true ,movable:false ,sortable:true, visible:true,readOnly:false,dataType:"number",styles:{textAlignment:"far" ,numberFormat:"###.#"}});
        columns.push({name:"t_point" ,fieldName:"t_point" ,header:"기술(T) 평점" ,width:100 ,editable:true ,movable:false ,sortable:true, visible:true,readOnly:false,dataType:"number",styles:{textAlignment:"far" ,numberFormat:"###.#"}});

        dataProvider.setFields(columns);
        gridView.setColumns(columns);
    }

    function loadData() {
        $.ajaxSetup({ cache: false });
        var params = { s_yyyymm :  encodeURIComponent('{{pre_yyyymm}}') }

        $.ajax({
            type:"POST",
            url:"samsong_evaluate_supp_q.jsp?{{query}}",
            contentType: "application/x-www-form-urlencoded; charset=UTF-8",
            data:params,
            success: function (data) {
                //alert(JSON.stringify(data.rows));
                dataProvider.fillJsonData(data,{rows :"rows", icon:"icon"});
            },
            error: function(request, status, error) {
                alert("code:" + request.status + "\n" + "error:" + error);
            },
            complete: function (data) {
                // setLoading(false);
                gridView.closeProgress();
                gridView.setFocus();
            }
        });

    };


    function formSubmit(f){
        if(validate(f)){
        	gridView.commit();
        	if(dataProvider.getRowCount()<1){
        		alert("평가정보를 1개 이상 등록 하세요.");
        		return false;
        	}
        	if(confirm("저장하시겠습니까?")){
        		var jRowsData = dataProvider.getJsonRows(0,dataProvider.getRowCount()-1);
        		var grid_string = encodeURIComponent(JSON.stringify(jRowsData));
        		f['data'].value=grid_string;
        		return true;	
        	}
        }
        return false;
    }
</script>