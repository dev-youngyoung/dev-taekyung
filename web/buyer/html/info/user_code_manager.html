<script type="text/javascript" src="/cab/realgrid/realgridjs-lic.js"></script>
<script type="text/javascript" src="/cab/realgrid/realgridjs.1.1.24.min.js"></script>
<script type="text/javascript" src="/cab/realgrid/realgridjs-api.1.1.24.js"></script>
<script type="text/javascript" src="/cab/realgrid/jszip.min.js"></script>

<script type="text/javascript">
    var treeDataProvider = null;
    var treeView = null;
    $(document).ready( function(){
        RealGridJS.setRootContext("{{realgrid_path}}");   //  cab/realgrid
        //RealGridJS.setTrace(true);

        // filed는 데이타 영역, 컬럼은 view영역

        treeDataProvider	= new RealGridJS.LocalTreeDataProvider();	//   Data source 객체
        treeView			= new RealGridJS.TreeView("realgrid");
        treeView.setDataSource(treeDataProvider);

        setOptions();
        setStyle();
        setColumns();
        loadData();
        setEvent();
    });

    function setOptions(){
        var options =  {
            hideDeletedRows : true,
            indicator:{visible: false }
            ,panel: {visible: false}
            ,footer: {visible: false}
            ,checkBar: {visible: false}
            ,stateBar: {visible: false}
            ,edit: {
                enterToTab: true,
                insertable: true,
                appendable: true,
                updatable: true,
                deletable: true,
                deleteRowsConfirm: true,
                deleteRowsMessage: "삭제하시겠습니까 ?"
            }
            ,displayOptions:{
                //columnWidth : 200
            }
        };
        treeView.setOptions(options);

        //폴더 이미지 등록
        var imgFiles = ["folder_close.gif","folder_open.gif","unknown.gif"];
        var imageList = new RealGridJS.ImageList("images", "/cab/realgrid/resource/");
        imageList.addUrls(imgFiles);
        // 트리뷰에 이미지 리스트 등록하기
        treeView.registerImageList(imageList);
        treeView.setTreeOptions({
            iconImages: imageList.getName(),
            iconWidth: 20
        });
    };

    function setStyle(){
        $.getJSON("/cab/realgrid/resource/fc_style.json", function (data, textStatus, jqXHR) {
            treeView.setStyles(data);
            $('.codeview.realtreestyle').html(JSON.stringify(data, null, 4));
        })
            .done(function (data, textStatus, jqXHR){
                treeView.setFocus();
            })
            .fail(function (jqxhr, textStatus, error){
                var err = textStatus + ', ' + error;
                var msg = "treeView failStyleSet: " + err;
                console && console.log(msg);
                alert(msg);

            });
    }



    function setColumns() {
        var columns = [];
        columns.push({name:"icon" ,fieldName:"icon" ,header:"icon" ,width:120 ,editable:true ,movable:false ,sortable:false, visible:false});
        columns.push({name:"code_nm" ,fieldName:"code_nm" ,header:"코드명" ,width: 450 ,editable:false ,movable:false ,sortable:false});
        columns.push({name:"depth" ,fieldName:"depth" ,header:"depth" ,editable:false ,movable:false ,sortable:false});
        columns.push({name:"l_cd" ,fieldName:"l_cd" ,header:"코드1" ,width:80 ,editable:true ,movable:false ,sortable:false, visible:false});
        columns.push({name:"m_cd" ,fieldName:"m_cd" ,header:"코드2" ,width:80 ,editable:true ,movable:false ,sortable:false, visible:false});
        columns.push({name:"s_cd" ,fieldName:"s_cd" ,header:"코드3" ,width:80 ,editable:true ,movable:false ,sortable:false, visible:false});
        columns.push({name:"d_cd" ,fieldName:"d_cd" ,header:"코드4" ,width:80 ,editable:true ,movable:false ,sortable:false, visible:false});
        columns.push({name:"code" ,fieldName:"code" ,header:"코드" ,width:80 ,editable:true ,movable:false ,sortable:false, visible:false});
        columns.push({name:"p_code" ,fieldName:"p_code" ,header:"부모코드" ,width:80 ,editable:true ,movable:false ,sortable:false, visible:false});
        columns.push({name:"depth" ,fieldName:"depth" ,header:"depth" ,width:50 ,editable:true ,movable:false ,sortable:false, visible:false});
        columns.push({name:"use_yn" ,fieldName:"use_yn" ,header:"사용여부" ,width: 80 ,editable:false , movable:false ,sortable:false, visible:false});
        columns.push({name:"end_node_yn" ,fieldName:"end_node_yn" ,header: "마지막 노드여부" ,width:130 ,editable:true ,movable:false ,sortable:false, visible:false});

        treeDataProvider.setFields(columns);
        treeView.setColumns(columns);	// 컬럼을 TreeView에 입력
        treeView.addCellRenderers(
            [{
                "id": "chk_use_yn",
                "type": "check",
                "shape": "box",
                "editable": true,
                "trueValues": "Y",
                "falseValues": "N",
            }]
        );

        treeView.setColumnProperty(treeView.columnByField("use_yn"),"dynamicStyles",[{ "criteria":"value!=Y","styles":{"renderer": "chk_use_yn"}}]);
    }

    function loadData() {
        $.ajaxSetup({ cache: false });

        var params = {};

        $.getJSON("./user_code_manager_q.jsp", params, function (data){
            // alert(JSON.stringify(data.authList));

            treeDataProvider.setJsonRows(data,"rows","","icon");
        })
            .done(function () {
                treeView.setFocus();
                treeView.expandAll();
            })
            .fail(function (jqxhr, textState, error) {
                var err = textState + ', ' + error;
                console.log("jQuery getJSON() Failed: " + err);
                alert("jQuery getJSON() Failed: " + err);
            })
    }

    function setEvent(){
        treeView.onTreeItemExpanded = function (tree, itemIndex, rowId) {
            treeDataProvider.setIconIndex(rowId,1);
        };
        treeView.onTreeItemCollapsed = function (tree, itemIndex, rowId) {
            treeDataProvider.setIconIndex(rowId,0);
        };
        treeView.onDataCellClicked = function(grid, index) {
            setItemData(treeDataProvider.getJsonRow(index.itemIndex+1));
            getParentItem(index.itemIndex+1);
        }
    }

    function getParentItem(itemIndex) {
        var arrItem=[];
        var parentIndex = treeDataProvider.getParent(itemIndex);
        while(parentIndex > -1) {
            arrItem.push(treeDataProvider.getJsonRow(parentIndex).code_nm);
            parentIndex = treeDataProvider.getParent(parentIndex);
        }
        var div_nm = '';
        for(var i=arrItem.length; i > 0; i--) {
            div_nm = div_nm + arrItem[i-1] + ' > ';
        }
        document.getElementById("span_div_nm").innerText=div_nm;
    }

    function setItemData(data){
        var f = document.forms['form1'];
        f['code_nm'].value = data.code_nm;
        f['l_cd'].value = data.l_cd;
        f['m_cd'].value = data.m_cd;
        f['s_cd'].value = data.s_cd;
        f['d_cd'].value = data.d_cd;
        f['end_node_yn'].value = data.end_node_yn;
        if(data.use_yn == 'Y') {
            f['use_yn'].checked = true;
        } else {
            f['use_yn'].checked = false;
        }
        f['depth'].value = data.depth;

        if(data.depth!='4') {
            document.getElementById("btnAddChild").style.display="";
        } else {
            document.getElementById("btnAddChild").style.display="none";
        }
        document.getElementById("btnAdd").style.display="";
        document.getElementById("btnSave").style.display="none";
        document.getElementById("btnModify").style.display="";
    }

    function fAddItem() {
        var f = document.forms['form1'];
        if(f['depth'].value=='') {
            alert('선택한 항목이 없습니다.');
            return;
        }
        if(f['depth'].value=='4') {
            f['d_cd'].value = '';
        } else if(f['depth'].value=='3') {
            f['s_cd'].value = '';
            f['d_cd'].value = '000';
        } else if(f['depth'].value=='2') {
            f['m_cd'].value = '';
            f['s_cd'].value = '000';
            f['d_cd'].value = '000';
        } else if(f['depth'].value=='1') {
            f['l_cd'].value = '';
            f['m_cd'].value = '000';
            f['s_cd'].value = '000';
            f['d_cd'].value = '000';
        }

        f['d_cd'].value = '';
        f['code_nm'].value = '';
        f['use_yn'].checked = false;

        document.getElementById("btnSave").style.display="";
        document.getElementById("btnModify").style.display="none";
        document.getElementById("btnAddChild").style.display="none";
    }

    function fAddItemChild() {
        var f = document.forms['form1'];
        if(f['depth'].value=='') {
            alert('선택한 항목이 없습니다.');
            return;
        }
        f['depth'].value = parseInt(f['depth'].value)+1;
        if(f['depth'].value=='4') {
            f['d_cd'].value = '';
        } else if(f['depth'].value=='3') {
            f['s_cd'].value = '';
            f['d_cd'].value = '000';
        } else if(f['depth'].value=='2') {
            f['m_cd'].value = '';
            f['s_cd'].value = '000';
            f['d_cd'].value = '000';
        } else if(f['depth'].value=='1') {
            f['l_cd'].value = '';
            f['m_cd'].value = '000';
            f['s_cd'].value = '000';
            f['d_cd'].value = '000';
        }
        f['code_nm'].value = '';
        f['use_yn'].checked = false;

        document.getElementById("btnSave").style.display="";
        document.getElementById("btnModify").style.display="none";
        document.getElementById("btnAdd").style.display="none";
    }

    function fSaveItem() {
        var f = document.forms['form1'];
        if(f['l_cd'].value=='' || f['m_cd'].value=='' || ['s_cd'].value=='' || f['d_cd'].value=='') {
            alert('코드를 입력해 주세요');
            f['l_cd'].focus();
            return;
        } else 	if(f['code_nm'].value=='') {
            alert('코드명을 입력해 주세요');
            f['code_nm'].focus();
            return;
        }

        if(!confirm("저장 하시겠습니까?")){
            return false;
        }

        var code_nm = Base64.encode(f['code_nm'].value);
		var url = "user_code_manager_a.jsp";
        //var formData = $("#form1").serialize();
        $.ajax({
            url : url,
            type : "post",
            data : {"mode":"I"
                ,"code_nm":code_nm
                ,"l_cd":f['l_cd'].value
                ,"m_cd":f['m_cd'].value
                ,"s_cd":f['s_cd'].value
                ,"d_cd":f['d_cd'].value
                ,"depth":f['depth'].value
                ,"use_yn":f['use_yn'].value
            },
            success : function(data) {
                if (data > 0) {
                    alert("처리되었습니다.");
                    location.reload();
                } else if (data < 0) {
                    alert("동일한 코드가 존재합니다.");
                } else {
                    alert("처리에 실패하였습니다.");
                }
            },
            error : function(request, status, error) {
                alert("code:" + request.status + "\n" + "error:" + error);
            }
        });
    }

    function fModifyItem() {
        var f = document.forms['form1'];
        if(f['l_cd'].value=='' || f['m_cd'].value=='' || ['s_cd'].value=='' || f['d_cd'].value=='') {
            alert('코드를 입력해 주세요');
            f['l_cd'].focus();
            return;
        } else 	if(f['code_nm'].value=='') {
            alert('코드명을 입력해 주세요');
            f['code_nm'].focus();
            return;
        }

        if(!confirm("수정 하시겠습니까?")){
            return false;
        }

        var code_nm = Base64.encode(f['code_nm'].value);
        var url = "user_code_manager_a.jsp";
        //var formData = $("#form1").serialize();
        $.ajax({
            url : url,
            type : "post",
            data : {"mode":"U"
                ,"code_nm":code_nm
                ,"l_cd":f['l_cd'].value
                ,"m_cd":f['m_cd'].value
                ,"s_cd":f['s_cd'].value
                ,"d_cd":f['d_cd'].value
                ,"depth":f['depth'].value
                ,"use_yn":f['use_yn'].value
            },
            success : function(data) {
                if (data > 0) {
                    alert("처리되었습니다.");
                    location.reload();
                } else {
                    alert("처리에 실패하였습니다.");
                }
            },
            error : function(request, status, error) {
                alert("code:" + request.status + "\n" + "error:" + error);
            }
        });
    }

    function fDelLItemDelete() {
        var f = document.forms['form1'];
        var url = "user_code_manager_a.jsp";
        if(f['end_node_yn'].value!='Y') {
            alert('하위 항목이 존재합니다');
            return false;
		}
        //var formData = $("#form1").serialize();
        if(!confirm("삭제 하시겠습니까?")){
            return false;
        }
        $.ajax({
            url : url,
            type : "post",
            data : {"mode":"D"
                ,"l_cd":f['l_cd'].value
                ,"m_cd":f['m_cd'].value
                ,"s_cd":f['s_cd'].value
                ,"d_cd":f['d_cd'].value
            },
            success : function(data) {
                if (data > 0) {
                    alert("처리되었습니다.");
                    location.reload();
                } else {
                    alert("처리에 실패하였습니다.");
                }
            },
            error : function(request, status, error) {
                alert("code:" + request.status + "\n" + "error:" + error);
            }
        });
    }
</script>

{{form_script}}

<form novalidate name="form1" id="form1" method="post">
<input type="hidden" name="depth" />
<input type="hidden" name="end_node_yn" />

<table border="0" width="100%">
	<colgroup>
		<col>
		<col width="5"/>
		<col width="500"/>
	</colgroup>
	<tr>
		<td valign="top">
			<div class="div_table">
				<div class="util-row">
					<div class="push-left">
						<h3>코드카테고리</h3>
					</div>
				</div>
				<div id="realgrid" style="width: 95%; height: 500px;"></div>
			</div>
		</td>
		<td>&nbsp;</td>
		<td valign="top">
			<div class="div_table">
				<div class="util-row">
					<div class="push-right">
						<button type="button" id="btnAdd"class="sbtn color auth_css" onClick="fAddItem();">동일depth품목추가</button>
						<button type="button" id="btnAddChild" class="sbtn color auth_css" onClick="fAddItemChild();" style="display: none">하위품목추가</button>
						<button type="button" id="btnDelete" class="sbtn color auth_css" onClick="fDelLItemDelete();">선택품목삭제</button>
						<button type="button" id="btnSave" class="sbtn color auth_css" onClick="fSaveItem();">품목저장</button>
						<button type="button" id="btnModify" class="sbtn color auth_css" onClick="fModifyItem();" style="display: none">품목수정</button>
					</div>
				</div>
				<table>
					<colgroup>
						<col width="120"/>
						<col/>
					</colgroup>
					<tr>
						<th>분류</th>
						<td style="padding-left:5px"><span id="span_div_nm"></span></td>
					</tr>
					<tr>
						<th class="req-check">코드</th>
						<td style="padding-left:5px">
							<input type="text" id="in_l_cd"  name="l_cd" size="1" maxlength="1">
							<input type="text" id="in_m_cd"  name="m_cd" size="3" maxlength="3">
							<input type="text" id="in_s_cd"  name="s_cd" size="3" maxlength="3">
							<input type="text" id="in_d_cd"  name="d_cd" size="3" maxlength="3">
						</td>
					</tr>
					<tr>
						<th class="req-check">코드명</th>
						<td style="padding-left:5px">
							<input type="text" id="in_code_nm" name="code_nm" size="255" maxlength="255" style="width:95%">
						</td>
					</tr>
					<tr>
						<th>사용여부</th>
						<td style="padding-left:5px">사용 <input type="checkbox" id="chk_use_yn" name="use_yn" value="Y"></td>
					</tr>
				</table>
			</div>
			<iframe name="ifm_item_unit" id="ifm_item_unit" src="" width="100%" height="400px" frameborder="0"></iframe>
		</td>
	</tr>
</table>
</form>